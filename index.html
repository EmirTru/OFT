<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kamera ve Sohbet UygulamasÄ±</title>
  <!-- Google Fonts for Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      /* Dikey ve yatayda tam ekran ortalama iÃ§in */
    }
    /* Sohbet ve medya galerisi iÃ§in kaydÄ±rma Ã§ubuÄŸu stili */
    #chat-messages-container, #media-gallery {
      scrollbar-width: thin;
      scrollbar-color: #4a5568 #2d3748;
    }
    #chat-messages-container::-webkit-scrollbar, #media-gallery::-webkit-scrollbar {
      width: 8px;
    }
    #chat-messages-container::-webkit-scrollbar-track, #media-gallery::-webkit-scrollbar-track {
      background: #2d3748;
      border-radius: 10px;
    }
    #chat-messages-container::-webkit-scrollbar-thumb, #media-gallery::-webkit-scrollbar-thumb {
      background-color: #4a5568;
      border-radius: 10px;
      border: 2px solid #2d3748;
    }
  </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8 flex items-center justify-center min-h-screen">

  <!-- Ana uygulama kabÄ± -->
  <div id="app-root" class="w-full max-w-6xl bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 flex flex-col space-y-6">
    <!-- UI iÃ§eriÄŸi, JavaScript tarafÄ±ndan buraya yÃ¼klenecek -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center h-64">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="mt-4 text-gray-400">YÃ¼kleniyor...</p>
    </div>
  </div>

  <!-- JavaScript tarafÄ±ndan kullanÄ±lacak gizli video ve canvas elementleri -->
  <video id="camera-video" class="hidden" autoplay playsinline></video>
  <canvas id="camera-canvas" class="hidden"></canvas>

  <!-- Uygulama JavaScript kodu -->
  <script type="module">
    // Firebase baÄŸlantÄ±sÄ± ve ana uygulama mantÄ±ÄŸÄ± iÃ§in JavaScript kodunuz buraya gelecek
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // Daha Ã¶nce saÄŸladÄ±ÄŸÄ±m JavaScript kodu iÃ§eriÄŸini buraya kopyala ve yapÄ±ÅŸtÄ±r
    // Bu kÄ±sÄ±m, tÃ¼m uygulama mantÄ±ÄŸÄ±nÄ± iÃ§erecektir
    
    // ######################################################################################
    // ########################### Ã–NEMLÄ°: GÃœVENLÄ°K KURALLARI ###############################
    // ######################################################################################
    // Bu kodun dÃ¼zgÃ¼n Ã§alÄ±ÅŸmasÄ± iÃ§in, aÅŸaÄŸÄ±daki kurallarÄ±n Firebase Firestore
    // konsolunda "Kurallar" bÃ¶lÃ¼mÃ¼ne yapÄ±ÅŸtÄ±rÄ±lmasÄ± ve yayÄ±mlanmasÄ± GEREKMEKTEDÄ°R.
    // AyrÄ±ca, Firebase Authentication'da Anonim (Anonymous) oturum aÃ§ma yÃ¶ntemi
    // etkinleÅŸtirilmelidir.
    //
    // rules_version = '2';
    //
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     // Bu kural, herhangi bir anonim kullanÄ±cÄ±nÄ±n (giriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±nÄ±n)
    //     // yeni bir baÄŸlantÄ± kodu oluÅŸturmasÄ±na ve bu kodu okumasÄ±na izin verir.
    //     // Bu, `createConnection` fonksiyonumuz iÃ§in gereklidir.
    //     match /artifacts/{appId}/public/data/connections/{connectionCode} {
    //       allow read, create: if request.auth != null;
    //     }
    //
    //     // Bu kural, baÄŸlantÄ± altÄ±nda bulunan `media` ve `chat` gibi alt koleksiyonlara
    //     // veri eklenmesine ve okunmasÄ±na izin verir.
    //     // `addDoc` ile fotoÄŸraf, video ve mesaj gÃ¶nderdiÄŸimiz yer burasÄ±dÄ±r.
    //     match /artifacts/{appId}/public/data/connections/{connectionCode}/{collectionName}/{documentId} {
    //       allow read, create: if request.auth != null;
    //     }
    //   }
    // }
    //
    // ######################################################################################
    
    // Bu uygulama, Firebase baÅŸlatma iÃ§in kanvas ortamÄ± tarafÄ±ndan saÄŸlanan
    // __firebase_config ve __initial_auth_token global deÄŸiÅŸkenlerini kullanÄ±r.
    // Bu deÄŸiÅŸkenleri deÄŸiÅŸtirmemek Ã¶nemlidir.
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Firestore yollarÄ± iÃ§in uygulama kimliÄŸi
    const appId = firebaseConfig ? firebaseConfig.projectId : 'default-app-id';
    
    // Firebase servisleri
    let app, db, auth;
    
    // Uygulama durumu deÄŸiÅŸkenleri
    let stream = null;
    let mediaGallery = [];
    let chatMessages = [];
    let isRecording = false;
    let isSending = false;
    let mediaCode = '';
    let connectionCode = null;
    let isVerici = false; // "Sender" in English. Indicates if this device is the one receiving media.
    let isConnecting = false;
    let userId = null;
    let connectionStatus = 'BaÄŸlantÄ± bekleniyor...';
    let modalMessage = null;
    let modalType = 'success';
    let isFirebaseReady = false;
    
    // DOM elementleri
    const appRoot = document.getElementById('app-root');
    const videoRef = document.getElementById('camera-video');
    const canvasRef = document.getElementById('camera-canvas');
    let mediaRecorder = null;
    let chunks = [];
    
    // YardÄ±mcÄ± fonksiyon: Tailwind sÄ±nÄ±flarÄ±nÄ± birleÅŸtirir
    const cn = (...classes) => classes.filter(Boolean).join(' ');
    
    // Modal gÃ¶steren fonksiyon
    const showModal = (message, type) => {
        modalMessage = message;
        modalType = type;
        renderUI();
    };
    
    // Modal kapatan fonksiyon
    const closeModal = () => {
        modalMessage = null;
        renderUI();
    };
    
    // Firestore dinleyicilerini kurar
    const setupFirestoreListeners = () => {
        if (!isFirebaseReady || !connectionCode || !userId) return {};
        
        console.log(`Firestore dinleyicileri kuruluyor. BaÄŸlantÄ± kodu: ${connectionCode}`);
    
        // Medya Galerisi iÃ§in dinleyici
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        const unsubscribeMedia = onSnapshot(mediaCollectionRef, (querySnapshot) => {
            const mediaList = [];
            querySnapshot.forEach((doc) => {
                mediaList.push({ id: doc.id, ...doc.data() });
            });
            mediaList.sort((a, b) => b.timestamp - a.timestamp);
            mediaGallery = mediaList;
            renderUI();
        }, (error) => {
            console.error("Firestore medya okuma hatasÄ±:", error);
            connectionStatus = 'Medya baÄŸlantÄ± hatasÄ±.';
            renderUI();
        });
    
        // Sohbet mesajlarÄ± iÃ§in dinleyici
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        const unsubscribeChat = onSnapshot(chatCollectionRef, (querySnapshot) => {
            const chatList = [];
            querySnapshot.forEach((doc) => {
                chatList.push({ id: doc.id, ...doc.data() });
            });
            chatList.sort((a, b) => a.timestamp - b.timestamp);
            chatMessages = chatList;
            renderUI();
            const chatEndRef = document.getElementById('chat-end');
            if (chatEndRef) {
                chatEndRef.scrollIntoView({ behavior: 'smooth' });
            }
        }, (error) => {
            console.error("Firestore sohbet okuma hatasÄ±:", error);
        });
    
        return { unsubscribeMedia, unsubscribeChat };
    };
    
    let unsubscribeFunctions = { unsubscribeMedia: null, unsubscribeChat: null };
    
    // Yeni bir baÄŸlantÄ± kodu oluÅŸturur
    const createConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yÃ¼kleniyor, lÃ¼tfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        renderUI();
        const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, newCode);
        
        console.log(`Yeni baÄŸlantÄ± oluÅŸturuluyor. Yol: /artifacts/${appId}/public/data/connections/${newCode}`);
    
        try {
            await setDoc(connectionDocRef, {
                creatorId: userId,
                status: 'waiting',
                timestamp: Date.now(),
            });
            connectionCode = newCode;
            isVerici = true;
            connectionStatus = `GÃ¶nderici kodu: ${newCode}. AlÄ±cÄ± bekleniyor...`;
            unsubscribeFunctions = setupFirestoreListeners();
        } catch (e) {
            console.error("Firestore baÄŸlantÄ± oluÅŸturma hatasÄ±:", e);
            showModal('BaÄŸlantÄ± oluÅŸturulamadÄ±. LÃ¼tfen Firebase gÃ¼venlik kurallarÄ±nÄ±zÄ± ve anonim oturum aÃ§ma ayarÄ±nÄ± kontrol edin.', 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };
    
    // Mevcut bir baÄŸlantÄ±ya katÄ±lÄ±r
    const joinConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yÃ¼kleniyor, lÃ¼tfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        connectionStatus = 'BaÄŸlanÄ±yor...';
        renderUI();
        
        console.log(`BaÄŸlantÄ±ya katÄ±lÄ±nÄ±yor. Kod: ${mediaCode}`);
    
        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, mediaCode);
        try {
            const docSnap = await getDoc(connectionDocRef);
            if (docSnap.exists()) {
                connectionCode = mediaCode;
                isVerici = false;
                connectionStatus = 'BaÄŸlantÄ± baÅŸarÄ±lÄ±! Kameraya geÃ§iliyor...';
                await startCamera();
                unsubscribeFunctions = setupFirestoreListeners();
            } else {
                connectionStatus = 'YanlÄ±ÅŸ kod veya baÄŸlantÄ± bulunamadÄ±.';
                showModal('BaÄŸlantÄ± bulunamadÄ±. LÃ¼tfen kodu kontrol edin.', 'error');
            }
        } catch (e) {
            console.error("Firestore baÄŸlantÄ± hatasÄ±:", e);
            connectionStatus = 'BaÄŸlantÄ± hatasÄ±.';
            showModal('BaÄŸlantÄ± hatasÄ±. LÃ¼tfen kodu ve Firebase gÃ¼venlik kurallarÄ±nÄ±zÄ± kontrol edin.', 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };
    
    // Kamera eriÅŸimini baÅŸlatÄ±r
    const startCamera = async () => {
        try {
            const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            stream = mediaStream;
            videoRef.srcObject = mediaStream;
            videoRef.play();
            connectionStatus = 'Kamera hazÄ±r. FotoÄŸraf veya video Ã§ekebilirsiniz.';
        } catch (err) {
            console.error("Kamera eriÅŸimi baÅŸarÄ±sÄ±z oldu:", err);
            connectionStatus = "Kamera eriÅŸimi baÅŸarÄ±sÄ±z. LÃ¼tfen izinleri kontrol edin.";
            showModal("Kamera eriÅŸimi reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan izin verin.", 'error');
        }
    };
    
    // Bir fotoÄŸraf Ã§eker ve Firestore'a gÃ¶nderir
    const takePhoto = async () => {
        if (!videoRef || !canvasRef || !connectionCode) return;
        isSending = true;
        renderUI();
    
        const context = canvasRef.getContext('2d');
        canvasRef.width = videoRef.videoWidth;
        canvasRef.height = videoRef.videoHeight;
        context.drawImage(videoRef, 0, 0, videoRef.videoWidth, videoRef.videoHeight);
        const photoDataUrl = canvasRef.toDataURL('image/png');
        
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        try {
            await addDoc(mediaCollectionRef, {
                type: 'photo',
                data: photoDataUrl,
                timestamp: Date.now(),
            });
            showModal("FotoÄŸraf baÅŸarÄ±yla gÃ¶nderildi!", 'success');
        } catch (e) {
            console.error("Firestore fotoÄŸraf gÃ¶nderme hatasÄ±:", e);
            showModal("FotoÄŸraf gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
        } finally {
            isSending = false;
            renderUI();
        }
    };
    
    // Video kaydÄ±nÄ± baÅŸlatÄ±r
    const startRecording = () => {
        if (!stream || !connectionCode) return;
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                chunks.push(e.data);
            }
        };
    
        mediaRecorder.onstop = async () => {
            isSending = true;
            renderUI();
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const videoDataUrl = reader.result;
                const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
                try {
                    await addDoc(mediaCollectionRef, {
                        type: 'video',
                        data: videoDataUrl,
                        timestamp: Date.now(),
                    });
                    showModal("Video baÅŸarÄ±yla gÃ¶nderildi!", 'success');
                } catch (e) {
                    console.error("Firestore video gÃ¶nderme hatasÄ±:", e);
                    showModal("Video gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
                } finally {
                    isSending = false;
                    renderUI();
                }
            };
        };
    
        mediaRecorder.start();
        isRecording = true;
        renderUI();
    };
    
    // Video kaydÄ±nÄ± durdurur
    const stopRecording = () => {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            renderUI();
        }
    };
    
    // Bir sohbet mesajÄ± gÃ¶nderir
    const sendChatMessage = async () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput && chatInput.value.trim() === '' || !connectionCode) return;
        
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        try {
            await addDoc(chatCollectionRef, {
                message: chatInput.value,
                senderId: userId,
                timestamp: Date.now(),
            });
            chatInput.value = '';
        } catch (e) {
            console.error("Sohbet mesajÄ± gÃ¶nderme hatasÄ±:", e);
            showModal("Mesaj gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
        }
    };
    
    // UygulamayÄ± sÄ±fÄ±rlar
    const resetApp = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (unsubscribeFunctions.unsubscribeMedia) unsubscribeFunctions.unsubscribeMedia();
        if (unsubscribeFunctions.unsubscribeChat) unsubscribeFunctions.unsubscribeChat();
    
        stream = null;
        mediaGallery = [];
        chatMessages = [];
        isVerici = false;
        isRecording = false;
        isSending = false;
        mediaCode = '';
        connectionCode = null;
        connectionStatus = 'BaÄŸlantÄ± bekleniyor...';
        
        renderUI();
    };
    
    // Ana fonksiyon: ArayÃ¼zÃ¼ oluÅŸturur ve gÃ¼nceller
    const renderUI = () => {
        appRoot.innerHTML = '';
        
        // Modal
        if (modalMessage) {
            const icon = modalType === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.62"/><path d="m9 11 3 3L22 4"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
            const title = modalType === 'success' ? 'BaÅŸarÄ±lÄ±' : 'Hata';
            const bgColor = modalType === 'success' ? 'bg-green-900' : 'bg-red-900';
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                  <div class="${cn("rounded-xl p-6 shadow-2xl flex flex-col items-center space-y-4", bgColor)}">
                    ${icon}
                    <h3 class="text-xl font-bold text-white">${title}</h3>
                    <p class="text-center text-gray-200">${modalMessage}</p>
                    <button id="modal-close-btn" class="w-full p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all font-semibold">
                      Tamam
                    </button>
                  </div>
                </div>
            `;
            appRoot.insertAdjacentHTML('afterbegin', modalHTML);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        }
    
        // Ana uygulama iÃ§eriÄŸi
        let mainContentHTML = ``;
    
        if (!isFirebaseReady) {
          mainContentHTML = `
            <div id="loading-spinner" class="flex flex-col items-center justify-center h-64">
              <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
              <p class="mt-4 text-gray-400">YÃ¼kleniyor...</p>
            </div>
          `;
        } else {
          mainContentHTML += `
            <!-- BaÅŸlÄ±k ve sÄ±fÄ±rlama butonu -->
            <header class="flex justify-between items-center pb-4 border-b border-gray-700">
                <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
                    Camera App ðŸ“¸
                </h1>
                <button id="reset-btn" class="flex items-center text-gray-400 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 12a9 9 0 0 1 9-9c2.97 0 5.71 1.18 7.72 3.19M21 12a9 9 0 0 1-9 9c-2.97 0-5.71-1.18-7.72-3.19M3 4V2h2M21 22v-2h-2"/><path d="M12 2a10 10 0 0 0-10 10"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                    SÄ±fÄ±rla
                </button>
            </header>
    
            <!-- BaÄŸlantÄ± durumu -->
            <div class="flex items-center justify-center p-3 rounded-lg bg-gray-700 text-sm font-medium">
                ${isConnecting || isSending ? '<span class="animate-pulse">Ä°ÅŸleniyor...</span>' : `<span>${connectionStatus}</span>`}
            </div>
          `;
          
          if (!connectionCode) {
              mainContentHTML += `
                  <!-- BaÄŸlantÄ± ArayÃ¼zÃ¼ -->
                  <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6 p-8">
                      <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-700 rounded-lg shadow-inner space-y-4">
                          <h2 class="text-xl md:text-2xl font-semibold text-center">GÃ¶nderici (Ekran)</h2>
                          <p class="text-center text-gray-400">
                              DiÄŸer cihazdan fotoÄŸraf/video almak iÃ§in bir baÄŸlantÄ± kodu oluÅŸturun.
                          </p>
                          <button id="create-connection-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isConnecting ? 'disabled' : ''}>
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                              BaÄŸlantÄ± OluÅŸtur
                          </button>
                      </div>
                      <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-700 rounded-lg shadow-inner space-y-4">
                          <h2 class="text-xl md:text-2xl font-semibold text-center">AlÄ±cÄ± (Kamera)</h2>
                          <p class="text-center text-gray-400">
                              BaÄŸlanmak ve medya gÃ¶ndermek iÃ§in gÃ¶nderici cihazdan gelen kodu girin.
                          </p>
                          <div class="flex flex-col w-full space-y-2">
                              <input id="media-code-input" type="text" value="${mediaCode}" placeholder="Kodu girin..." class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                              <button id="join-connection-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isConnecting || mediaCode.length !== 6 ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>
                                  BaÄŸlan
                              </button>
                          </div>
                      </div>
                  </div>
              `;
          } else {
              let mediaSection = '';
              if (!isVerici && stream) {
                  mediaSection = `<div class="w-full h-full"><video id="camera-video-display" class="w-full h-full object-cover rounded-xl" autoplay playsinline></video></div>`;
              } else if (isVerici && mediaGallery.length === 0) {
                  mediaSection = `<div class="text-gray-400 p-4 text-center">AlÄ±cÄ± cihazdan medya bekleniyor...</div>`;
              } else if (isVerici && mediaGallery.length > 0) {
                  mediaSection = `<div id="media-gallery" class="w-full h-full p-2 grid grid-cols-2 gap-2 overflow-y-auto">
                      ${mediaGallery.map(media => `
                          <div class="relative rounded-lg overflow-hidden border border-gray-600">
                              ${media.type === 'photo' ? `<img src="${media.data}" alt="Received Photo" class="w-full h-auto object-cover" />` : `<video src="${media.data}" controls class="w-full h-auto object-cover"></video>`}
                          </div>
                      `).join('')}
                  </div>`;
              }
    
              let controlSection = '';
              if (!isVerici) {
                  controlSection = `
                      <div class="w-full md:w-1/2 flex flex-col space-y-4">
                          <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                              <button id="take-photo-btn" class="flex-1 flex items-center justify-center p-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isSending ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                  ${isSending ? 'GÃ¶nderiliyor...' : 'FotoÄŸraf Ã‡ek'}
                              </button>
                              <button id="record-video-btn" class="${cn('flex-1 flex items-center justify-center p-4 rounded-lg text-white font-semibold transition-all shadow-md disabled:bg-gray-500', isRecording ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700')}" ${isSending ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                                  ${isRecording ? 'KaydÄ± Durdur' : 'Video Kaydet'}
                              </button>
                          </div>
                          <div class="flex-1 mt-6 p-4 rounded-xl bg-gray-700 shadow-inner overflow-hidden flex items-center justify-center text-gray-400">
                              Kamera modundasÄ±nÄ±z. Ã‡ektiÄŸiniz medya diÄŸer cihaza gÃ¶nderilecektir.
                          </div>
                      </div>
                  `;
              } else {
                  controlSection = `
                      <div class="w-full md:w-1/2 flex flex-col space-y-4">
                          <div class="flex-1 flex flex-col space-y-4">
                              <div class="p-4 rounded-xl bg-gray-700 shadow-inner overflow-hidden flex flex-col h-full">
                                  <h3 class="text-lg font-bold mb-2 flex items-center">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                      Sohbet
                                  </h3>
                                  <div id="chat-messages-container" class="flex-1 overflow-y-auto p-2 bg-gray-800 rounded-lg mb-2 flex flex-col space-y-2">
                                      ${chatMessages.map(msg => `
                                          <div class="${cn('p-2 rounded-lg max-w-[80%]', msg.senderId === userId ? 'bg-blue-600 self-end text-right' : 'bg-gray-600 self-start text-left')}">
                                              <p class="text-sm">${msg.message}</p>
                                              <span class="text-xs text-gray-300 mt-1 block">
                                                  ${new Date(msg.timestamp).toLocaleTimeString()}
                                              </span>
                                          </div>
                                      `).join('')}
                                      <div id="chat-end"></div>
                                  </div>
                                  <div class="flex space-x-2">
                                      <input id="chat-input" type="text" placeholder="Bir mesaj yazÄ±n..." class="flex-1 p-2 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                      <button id="send-chat-btn" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-all shadow-md">
                                          GÃ¶nder
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
              }
    
              mainContentHTML += `
                  <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                      <div class="relative w-full md:w-1/2 rounded-xl overflow-hidden shadow-xl border-2 border-gray-700 bg-gray-900 flex items-center justify-center">
                          ${mediaSection}
                      </div>
                      ${controlSection}
                  </div>
              `;
          }
        }
    
        appRoot.innerHTML = mainContentHTML;
        
        // Olay dinleyicilerini ekle
        document.getElementById('reset-btn')?.addEventListener('click', resetApp);
        
        if (!connectionCode) {
            document.getElementById('create-connection-btn')?.addEventListener('click', createConnection);
            const mediaCodeInput = document.getElementById('media-code-input');
            const joinButton = document.getElementById('join-connection-btn');
            
            mediaCodeInput?.addEventListener('input', (e) => {
                mediaCode = e.target.value.toUpperCase();
                joinButton.disabled = isConnecting || mediaCode.length !== 6;
            });
            joinButton?.addEventListener('click', joinConnection);
        } else {
            // Kamera veya sohbet butonlarÄ±
            if (!isVerici) {
                document.getElementById('take-photo-btn')?.addEventListener('click', takePhoto);
                const recordVideoBtn = document.getElementById('record-video-btn');
                recordVideoBtn?.addEventListener('click', () => {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                document.getElementById('send-chat-btn')?.addEventListener('click', sendChatMessage);
                document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        }
    
        // Kamera video ve tuval elementlerini DOM'a ekle (gizli)
        if (!document.body.contains(videoRef)) {
          videoRef.style.display = 'none';
          document.body.appendChild(videoRef);
        }
        if (!document.body.contains(canvasRef)) {
          canvasRef.style.display = 'none';
          document.body.appendChild(canvasRef);
        }
    
        // Kamera akÄ±ÅŸÄ±nÄ± video elementine ata
        if (!isVerici && connectionCode) {
            const videoDisplay = document.getElementById('camera-video-display');
            if (videoDisplay) {
                videoRef.srcObject = stream;
                videoDisplay.srcObject = stream;
            }
        }
    };
    
    // Firebase baÅŸlatma fonksiyonu
    const initFirebase = async () => {
        try {
            if (!firebaseConfig) {
                showModal("Firebase yapÄ±landÄ±rmasÄ± bulunamadÄ±. LÃ¼tfen Canvas ortamÄ±nÄ± kontrol edin.", 'error');
                isFirebaseReady = false;
                renderUI();
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Kimlik doÄŸrulama durumu Ã§Ã¶zÃ¼lene kadar bekle
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseReady = true;
                    renderUI();
                } else {
                    try {
                        // EÄŸer Ã¶zel bir token varsa onu kullan, yoksa anonim giriÅŸ yap
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth hatasÄ±:", e);
                        let errorMessage = `Firebase baÄŸlantÄ±sÄ± kurulurken bir hata oluÅŸtu: ${e.message}`;
                        if (e.code === 'auth/configuration-not-found') {
                             errorMessage = 'Hata: Firebase projenizde "Anonymous" (Anonim) oturum aÃ§ma yÃ¶ntemi etkinleÅŸtirilmemiÅŸ. LÃ¼tfen Firebase konsolundan bu ayarÄ± yapÄ±n.';
                        }
                        showModal(errorMessage, 'error');
                    } finally {
                        isFirebaseReady = true;
                        renderUI();
                    }
                }
            });
    
        } catch (e) {
            console.error("Firebase baÅŸlatma hatasÄ±:", e);
            showModal("Uygulama baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu: Firebase yapÄ±landÄ±rmasÄ± yanlÄ±ÅŸ olabilir.", 'error');
            isFirebaseReady = false;
            renderUI();
        }
    };
    
    // UygulamayÄ± baÅŸlat
    initFirebase();
  </script>
</body>
</html>
