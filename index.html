<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kamera Uygulaması</title>
  <!-- Google Fonts for Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8 flex items-center justify-center min-h-screen">

  <div id="app-root" class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 flex flex-col space-y-6">
    <!-- UI content will be loaded here via JavaScript -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center h-64">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="mt-4 text-gray-400">Yükleniyor...</p>
    </div>
  </div>
  
  <!-- Video and Canvas elements added to the DOM, but not visible -->
  <video id="camera-video" style="display: none;" autoplay playsinline></video>
  <canvas id="camera-canvas" style="display: none;"></canvas>

  <script type="module">
    // Firebase modüllerini import et
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ######################################################################################
    // ##################### YAPILANDIRMA BİLGİLERİ (Canvas ortamından otomatik alınacak) #####################
    // ######################################################################################
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase services
    let app, db, auth;

    // State variables
    let stream = null;
    let mediaGallery = [];
    let chatMessages = [];
    let isRecording = false;
    let isSending = false;
    let mediaCode = '';
    let connectionCode = null;
    let isVerici = false;
    let isConnecting = false;
    let userId = null;
    let connectionStatus = 'Bağlantı bekleniyor...';
    let modalMessage = null;
    let modalType = 'success';
    let isFirebaseReady = false;

    // DOM elements
    const appRoot = document.getElementById('app-root');
    const videoRef = document.getElementById('camera-video');
    const canvasRef = document.getElementById('camera-canvas');
    let mediaRecorder = null;
    let chunks = [];

    // Helper function: Tailwind sınıflarını birleştirir
    const cn = (...classes) => classes.filter(Boolean).join(' ');

    // Fonksiyon: Modal gösterir
    const showModal = (message, type) => {
        modalMessage = message;
        modalType = type;
        renderUI();
    };

    // Fonksiyon: Modalı kapatır
    const closeModal = () => {
        modalMessage = null;
        renderUI();
    };

    // Firestore dinleyicilerini ayarlar
    const setupFirestoreListeners = () => {
        if (!isFirebaseReady || !connectionCode || !userId) {
          console.warn("Firestore dinleyicileri başlatılamadı: Firebase hazır değil veya bağlantı kodu/kullanıcı kimliği eksik.");
          return;
        }

        // Medya Galerisini Dinle
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        const unsubscribeMedia = onSnapshot(mediaCollectionRef, (querySnapshot) => {
            const mediaList = [];
            querySnapshot.forEach((doc) => {
                mediaList.push({ id: doc.id, ...doc.data() });
            });
            mediaList.sort((a, b) => b.timestamp - a.timestamp);
            mediaGallery = mediaList;
            renderUI();
        }, (error) => {
            console.error("Firestore medya okuma hatası:", error);
            connectionStatus = 'Medya bağlantı hatası.';
            showModal(`Medya akışını alırken hata oluştu: ${error.message}`, 'error');
            renderUI();
        });

        // Sohbet Mesajlarını Dinle
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        const unsubscribeChat = onSnapshot(chatCollectionRef, (querySnapshot) => {
            const chatList = [];
            querySnapshot.forEach((doc) => {
                chatList.push({ id: doc.id, ...doc.data() });
            });
            chatList.sort((a, b) => a.timestamp - b.timestamp);
            chatMessages = chatList;
            renderUI();
            const chatEndRef = document.getElementById('chat-end');
            if (chatEndRef) {
                chatEndRef.scrollIntoView({ behavior: 'smooth' });
            }
        }, (error) => {
            console.error("Firestore sohbet okuma hatası:", error);
            showModal(`Sohbet mesajlarını alırken hata oluştu: ${error.message}`, 'error');
        });

        return { unsubscribeMedia, unsubscribeChat };
    };

    let unsubscribeFunctions = { unsubscribeMedia: null, unsubscribeChat: null };

    // Yeni bir bağlantı kodu oluşturur
    const createConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yükleniyor, lütfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        renderUI();
        const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, newCode);
        
        try {
            await Promise.race([
                setDoc(connectionDocRef, {
                    creatorId: userId,
                    status: 'waiting',
                    timestamp: Date.now(),
                }),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Connection creation timed out.')), 10000))
            ]);
            
            connectionCode = newCode;
            isVerici = true;
            connectionStatus = `Gönderici kodu: ${newCode}. Alıcı bekleniyor...`;
            unsubscribeFunctions = setupFirestoreListeners();
        } catch (e) {
            console.error("Firestore bağlantı oluşturma hatası:", e);
            showModal(`Bağlantı oluşturulamadı: ${e.message || 'Bilinmeyen bir hata oluştu.'}`, 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };

    // Bir bağlantıya katılır
    const joinConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yükleniyor, lütfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        connectionStatus = 'Bağlanıyor...';
        renderUI();

        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, mediaCode);
        try {
            const docSnap = await Promise.race([
                getDoc(connectionDocRef),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Connection lookup timed out.')), 10000))
            ]);

            if (docSnap.exists()) {
                connectionCode = mediaCode;
                isVerici = false;
                connectionStatus = 'Bağlantı başarılı! Kameraya geçiliyor...';
                await startCamera();
                unsubscribeFunctions = setupFirestoreListeners();
            } else {
                connectionStatus = 'Yanlış kod veya bağlantı bulunamadı.';
                showModal('Bağlantı bulunamadı. Lütfen kodu kontrol edin.', 'error');
            }
        } catch (e) {
            console.error("Firestore bağlantı hatası:", e);
            connectionStatus = 'Bağlantı hatası.';
            showModal(`Bağlantı hatası: ${e.message || 'Bilinmeyen bir hata oluştu.'}`, 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };

    // Kamera erişimini başlatır
    const startCamera = async () => {
        try {
            const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            stream = mediaStream;
            videoRef.srcObject = mediaStream;
            videoRef.play();
            connectionStatus = 'Kamera hazır. Fotoğraf veya video çekebilirsiniz.';
        } catch (err) {
            console.error("Kamera erişimi başarısız oldu:", err);
            connectionStatus = "Kamera erişimi başarısız oldu. Lütfen izinleri kontrol edin.";
            showModal("Kamera erişimi reddedildi. Lütfen tarayıcı ayarlarınızdan izinleri verin.", 'error');
        }
    };

    // Fotoğraf çeker ve Firestore'a gönderir
    const takePhoto = async () => {
        if (!videoRef || !canvasRef || !connectionCode) return;
        isSending = true;
        renderUI();

        const context = canvasRef.getContext('2d');
        canvasRef.width = videoRef.videoWidth;
        canvasRef.height = videoRef.videoHeight;
        context.drawImage(videoRef, 0, 0, videoRef.videoWidth, videoRef.videoHeight);
        const photoDataUrl = canvasRef.toDataURL('image/png');
        
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        try {
            await addDoc(mediaCollectionRef, {
                type: 'photo',
                data: photoDataUrl,
                timestamp: Date.now(),
            });
            showModal("Fotoğraf başarıyla gönderildi!", 'success');
        } catch (e) {
            console.error("Firestore fotoğraf gönderme hatası:", e);
            showModal("Fotoğraf gönderilirken bir hata oluştu.", 'error');
        } finally {
            isSending = false;
            renderUI();
        }
    };

    // Video kaydını başlatır
    const startRecording = () => {
        if (!stream || !connectionCode) return;
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                chunks.push(e.data);
            }
        };

        mediaRecorder.onstop = async () => {
            isSending = true;
            renderUI();
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const videoDataUrl = reader.result;
                const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
                try {
                    await addDoc(mediaCollectionRef, {
                        type: 'video',
                        data: videoDataUrl,
                        timestamp: Date.now(),
                    });
                    showModal("Video başarıyla gönderildi!", 'success');
                } catch (e) {
                    console.error("Firestore video gönderme hatası:", e);
                    showModal("Video gönderilirken bir hata oluştu.", 'error');
                } finally {
                    isSending = false;
                    renderUI();
                }
            };
        };

        mediaRecorder.start();
        isRecording = true;
        renderUI();
    };

    // Video kaydını durdurur
    const stopRecording = () => {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            renderUI();
        }
    };

    // Sohbet mesajı gönderir
    const sendChatMessage = async () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput && chatInput.value.trim() === '' || !connectionCode) return;
        
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        try {
            await addDoc(chatCollectionRef, {
                message: chatInput.value,
                senderId: userId,
                timestamp: Date.now(),
            });
            chatInput.value = '';
        } catch (e) {
            console.error("Sohbet mesajı gönderme hatası:", e);
            showModal("Mesaj gönderilirken bir hata oluştu.", 'error');
        }
    };

    // Uygulamayı sıfırlar
    const resetApp = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (unsubscribeFunctions.unsubscribeMedia) unsubscribeFunctions.unsubscribeMedia();
        if (unsubscribeFunctions.unsubscribeChat) unsubscribeFunctions.unsubscribeChat();

        stream = null;
        mediaGallery = [];
        chatMessages = [];
        isVerici = false;
        isRecording = false;
        isSending = false;
        mediaCode = '';
        connectionCode = null;
        connectionStatus = 'Bağlantı bekleniyor...';
        
        renderUI();
    };

    // Arayüzü oluşturur ve günceller
    const renderUI = () => {
        appRoot.innerHTML = '';
        
        // Modal
        if (modalMessage) {
            const icon = modalType === 'success' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.62"/><path d="m9 11 3 3L22 4"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
            const title = modalType === 'success' ? 'Başarılı' : 'Hata';
            const bgColor = modalType === 'success' ? 'bg-green-900' : 'bg-red-900';
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                  <div class="${cn("rounded-xl p-6 shadow-2xl flex flex-col items-center space-y-4", bgColor)}">
                    ${icon}
                    <h3 class="text-xl font-bold text-white">${title}</h3>
                    <p class="text-center text-gray-200">${modalMessage}</p>
                    <button id="modal-close-btn" class="w-full p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all font-semibold">
                      Tamam
                    </button>
                  </div>
                </div>
            `;
            appRoot.insertAdjacentHTML('afterbegin', modalHTML);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        }

        // Ana uygulama içeriği
        let mainContentHTML = ``;

        if (!isFirebaseReady) {
          mainContentHTML = `
            <div class="flex flex-col items-center justify-center h-64">
              <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
              <p class="mt-4 text-gray-400">Yükleniyor...</p>
            </div>
          `;
        } else {
          mainContentHTML += `
            <!-- Başlık ve sıfırlama butonu -->
            <header class="flex justify-between items-center pb-4 border-b border-gray-700">
                <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
                    Kamera Uygulaması 📸
                </h1>
                <button id="reset-btn" class="flex items-center text-gray-400 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 12a9 9 0 0 1 9-9c2.97 0 5.71 1.18 7.72 3.19M21 12a9 9 0 0 1-9 9c-2.97 0-5.71-1.18-7.72-3.19M3 4V2h2M21 22v-2h-2"/><path d="M12 2a10 10 0 0 0-10 10"/><path d="M22 12a10 10 0 0 1-10 10"/></svg>
                    Sıfırla
                </button>
            </header>

            <!-- Bağlantı Durumu -->
            <div class="flex items-center justify-center p-3 rounded-lg bg-gray-700 text-sm font-medium">
                ${isConnecting || isSending ? '<span class="animate-pulse">İşleniyor...</span>' : `<span>${connectionStatus}</span>`}
            </div>
          `;
          
          if (!connectionCode) {
              mainContentHTML += `
                  <!-- Bağlantı Arayüzü -->
                  <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6 p-8">
                      <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-700 rounded-lg shadow-inner space-y-4">
                          <h2 class="text-xl md:text-2xl font-semibold text-center">Gönderici (Ekran)</h2>
                          <p class="text-center text-gray-400">
                              Başka bir cihazdan fotoğraf/video almak için bir bağlantı kodu oluşturun.
                          </p>
                          <button id="create-connection-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isConnecting ? 'disabled' : ''}>
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                              Bağlantı Oluştur
                          </button>
                      </div>
                      <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-700 rounded-lg shadow-inner space-y-4">
                          <h2 class="text-xl md:text-2xl font-semibold text-center">Alıcı (Kamera)</h2>
                          <p class="text-center text-gray-400">
                              Gönderici cihazdan gelen kodu girerek bağlanın ve medya gönderin.
                          </p>
                          <div class="flex flex-col w-full space-y-2">
                              <input id="media-code-input" type="text" value="${mediaCode}" placeholder="Kodu girin..." class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                              <button id="join-connection-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isConnecting || mediaCode.length !== 6 ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>
                                  Bağlan
                              </button>
                          </div>
                      </div>
                  </div>
              `;
          } else {
              let mediaSection = '';
              if (!isVerici && stream) {
                  // Alıcıysak ve kamera akışı aktifse, kamera önizlemesini göster
                  mediaSection = `<div class="w-full h-full"><video id="camera-video-display" class="w-full h-full object-cover rounded-xl" autoplay playsinline></video></div>`;
              } else if (isVerici && mediaGallery.length === 0) {
                  // Göndericiysek ve henüz medya alınmadıysa
                  mediaSection = `<div class="text-gray-400 p-4 text-center">Alıcı cihazdan medya bekleniyor...</div>`;
              } else if (isVerici && mediaGallery.length > 0) {
                  // Göndericiysek ve medya alındıysa, galeriyi göster
                  mediaSection = `<div id="media-gallery" class="w-full h-full p-2 grid grid-cols-2 gap-2 overflow-y-auto">
                      ${mediaGallery.map(media => `
                          <div class="relative rounded-lg overflow-hidden border border-gray-600">
                              ${media.type === 'photo' ? `<img src="${media.data}" alt="Alınan Fotoğraf" class="w-full h-auto object-cover" />` : `<video src="${media.data}" controls class="w-full h-auto object-cover"></video>`}
                          </div>
                      `).join('')}
                  </div>`;
              }

              let controlSection = '';
              if (!isVerici) {
                  // Bu, alıcı (kamera) için arayüz
                  controlSection = `
                      <div class="w-full md:w-1/2 flex flex-col space-y-4">
                          <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                              <button id="take-photo-btn" class="flex-1 flex items-center justify-center p-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-semibold transition-all shadow-md disabled:bg-gray-500" ${isSending ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                  ${isSending ? 'Gönderiliyor...' : 'Fotoğraf Çek'}
                              </button>
                              <button id="record-video-btn" class="${cn('flex-1 flex items-center justify-center p-4 rounded-lg text-white font-semibold transition-all shadow-md disabled:bg-gray-500', isRecording ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700')}" ${isSending ? 'disabled' : ''}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                                  ${isRecording ? 'Kaydı Durdur' : 'Video Kaydet'}
                              </button>
                          </div>
                          <div class="flex-1 mt-6 p-4 rounded-xl bg-gray-700 shadow-inner overflow-hidden flex items-center justify-center text-gray-400">
                              Kamera modundasınız. Çektiğiniz medya diğer cihaza gönderilecektir.
                          </div>
                      </div>
                  `;
              } else {
                  // Bu, gönderici (ekran) ve sohbet için arayüz
                  controlSection = `
                      <div class="w-full md:w-1/2 flex flex-col space-y-4">
                          <div class="flex-1 flex flex-col space-y-4">
                              <div class="p-4 rounded-xl bg-gray-700 shadow-inner overflow-hidden flex flex-col h-full">
                                  <h3 class="text-lg font-bold mb-2 flex items-center">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                      Sohbet
                                  </h3>
                                  <div id="chat-messages-container" class="flex-1 overflow-y-auto p-2 bg-gray-800 rounded-lg mb-2 flex flex-col space-y-2">
                                      ${chatMessages.map(msg => `
                                          <div class="${cn('p-2 rounded-lg max-w-[80%]', msg.senderId === userId ? 'bg-blue-600 self-end text-right' : 'bg-gray-600 self-start text-left')}">
                                              <p class="text-sm">${msg.message}</p>
                                              <span class="text-xs text-gray-300 mt-1 block">
                                                  ${new Date(msg.timestamp).toLocaleTimeString()}
                                              </span>
                                          </div>
                                      `).join('')}
                                      <div id="chat-end"></div>
                                  </div>
                                  <div class="flex space-x-2">
                                      <input id="chat-input" type="text" placeholder="Bir mesaj yazın..." class="flex-1 p-2 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                      <button id="send-chat-btn" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-all shadow-md">
                                          Gönder
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
              }

              mainContentHTML += `
                  <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                      <div class="relative w-full md:w-1/2 rounded-xl overflow-hidden shadow-xl border-2 border-gray-700 bg-gray-900 flex items-center justify-center">
                          ${mediaSection}
                      </div>
                      ${controlSection}
                  </div>
              `;
          }
        }

        appRoot.innerHTML = mainContentHTML;
        
        // Olay dinleyicilerini ekle
        document.getElementById('reset-btn')?.addEventListener('click', resetApp);
        
        if (!connectionCode) {
            document.getElementById('create-connection-btn')?.addEventListener('click', createConnection);
            const mediaCodeInput = document.getElementById('media-code-input');
            const joinButton = document.getElementById('join-connection-btn');
            
            mediaCodeInput?.addEventListener('input', (e) => {
                mediaCode = e.target.value.toUpperCase();
                joinButton.disabled = isConnecting || mediaCode.length !== 6;
            });
            joinButton?.addEventListener('click', joinConnection);
        } else {
            if (!isVerici) {
                document.getElementById('take-photo-btn')?.addEventListener('click', takePhoto);
                const recordVideoBtn = document.getElementById('record-video-btn');
                recordVideoBtn?.addEventListener('click', () => {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                document.getElementById('send-chat-btn')?.addEventListener('click', sendChatMessage);
                document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        }

        if (!document.body.contains(videoRef)) {
          videoRef.style.display = 'none';
          document.body.appendChild(videoRef);
        }
        if (!document.body.contains(canvasRef)) {
          canvasRef.style.display = 'none';
          document.body.appendChild(canvasRef);
        }

        if (!isVerici && connectionCode) {
            const videoDisplay = document.getElementById('camera-video-display');
            if (videoDisplay) {
                videoRef.srcObject = stream;
                videoDisplay.srcObject = stream;
            }
        }
    };
    
    // Firebase başlangıç fonksiyonu
    const initFirebase = async () => {
      try {
        console.log("Firebase başlatılıyor...");
        
        // Firebase yapılandırma bilgilerini kontrol et
        if (!firebaseConfig) {
          showModal("Firebase yapılandırma bilgileri eksik. Lütfen Canvas uygulamasının doğru şekilde yüklendiğinden emin olun.", 'error');
          return;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        console.log("onAuthStateChanged dinleyicisi ayarlanıyor...");
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isFirebaseReady = true;
                console.log(`Firebase hazır. Kullanıcı kimliği: ${userId}`);
                renderUI();
            } else {
                console.log("Kullanıcı oturumu açılmamış. Anonim olarak oturum açmayı deniyorum...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Firebase Kimlik Doğrulama hatası:", e);
                    let errorMessage = `Firebase'a bağlanırken bir hata oluştu: ${e.message}`;
                    if (e.code === 'auth/configuration-not-found') {
                        errorMessage = 'Hata: Firebase projenizde "Anonymous" (Anonim) oturum açma yöntemi etkinleştirilmemiş.';
                    } else if (e.code === 'auth/network-request-failed') {
                        errorMessage = 'Hata: İnternet bağlantınızda sorun olabilir. Lütfen kontrol edin.';
                    }
                    showModal(errorMessage, 'error');
                    isFirebaseReady = false;
                    renderUI();
                }
            }
        });

      } catch (e) {
        console.error("Firebase başlatma hatası:", e);
        showModal(`Uygulama başlatılırken bir hata oluştu: ${e.message}`, 'error');
        isFirebaseReady = false;
        renderUI();
      }
    };

    // Uygulamayı başlat
    initFirebase();
  </script>
</body>
</html>
