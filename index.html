<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kamera UygulamasÄ±</title>
    <!-- Sadece temel, inline CSS kullanÄ±ldÄ± -->
    <style>
        body {
            font-family: sans-serif;
            background-color: #2c2c2c;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #3e3e3e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status-bar {
            text-align: center;
            padding: 10px;
            background-color: #555;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .connection-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .connection-card {
            background-color: #4a4a4a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .connection-card h2 {
            margin-top: 0;
            font-size: 20px;
        }
        .connection-card p {
            font-size: 14px;
            color: #bbb;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .input-group input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #666;
            background-color: #3e3e3e;
            color: #ffffff;
        }
        .btn {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-green {
            background-color: #22c55e;
            color: #fff;
        }
        .btn-green:hover {
            background-color: #16a34a;
        }
        .btn-blue {
            background-color: #3b82f6;
            color: #fff;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        .btn-purple {
            background-color: #8b5cf6;
            color: #fff;
        }
        .btn-purple:hover {
            background-color: #7c3aed;
        }
        .btn-red {
            background-color: #ef4444;
            color: #fff;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        .btn-reset {
            background-color: transparent;
            color: #bbb;
        }
        .btn-reset:hover {
            color: #fff;
        }
        .btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .media-and-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .media-display {
            width: 100%;
            background-color: #1f1f1f;
            min-height: 200px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .media-display video, .media-display img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .media-item {
            border: 1px solid #555;
            border-radius: 5px;
            overflow: hidden;
        }
        .chat-section {
            background-color: #4a4a4a;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background-color: #3e3e3e;
            border-radius: 5px;
        }
        .chat-message {
            padding: 8px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.sent {
            background-color: #3b82f6;
            align-self: flex-end;
        }
        .chat-message.received {
            background-color: #666;
            align-self: flex-start;
        }
        .chat-input-group {
            display: flex;
            gap: 5px;
        }
        .chat-input-group input {
            flex-grow: 1;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #3e3e3e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        @media (min-width: 768px) {
            .connection-options {
                flex-direction: row;
            }
            .media-and-controls {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>

  <div id="app-root" class="container">
    <div style="text-align: center;">
      <p>YÃ¼kleniyor...</p>
    </div>
  </div>
  
  <video id="camera-video" style="display: none;" autoplay playsinline></video>
  <canvas id="camera-canvas" style="display: none;"></canvas>

  <script type="module">
    // Firebase modÃ¼llerini import et
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Canvas ortamÄ±ndan otomatik olarak alÄ±nan Firebase yapÄ±landÄ±rma bilgileri
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase servisleri
    let app, db, auth;

    // UygulamanÄ±n durumunu tutan deÄŸiÅŸkenler
    let stream = null;
    let mediaGallery = [];
    let chatMessages = [];
    let isRecording = false;
    let isSending = false;
    let mediaCode = '';
    let connectionCode = null;
    let isVerici = false;
    let isConnecting = false;
    let userId = null;
    let connectionStatus = 'BaÄŸlantÄ± bekleniyor...';
    let modalMessage = null;
    let modalType = 'success';
    let isFirebaseReady = false;

    // DOM elemanlarÄ±
    const appRoot = document.getElementById('app-root');
    const videoRef = document.getElementById('camera-video');
    const canvasRef = document.getElementById('camera-canvas');
    let mediaRecorder = null;
    let chunks = [];

    // Fonksiyon: Modal gÃ¶sterir
    const showModal = (message, type) => {
        modalMessage = message;
        modalType = type;
        renderUI();
    };

    // Fonksiyon: ModalÄ± kapatÄ±r
    const closeModal = () => {
        modalMessage = null;
        renderUI();
    };

    // Firestore dinleyicilerini ayarlar
    const setupFirestoreListeners = () => {
        if (!isFirebaseReady || !connectionCode || !userId) {
          console.warn("Firestore dinleyicileri baÅŸlatÄ±lamadÄ±: Firebase hazÄ±r deÄŸil veya baÄŸlantÄ± kodu/kullanÄ±cÄ± kimliÄŸi eksik.");
          return;
        }

        // Medya Galerisini Dinle
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        const unsubscribeMedia = onSnapshot(mediaCollectionRef, (querySnapshot) => {
            const mediaList = [];
            querySnapshot.forEach((doc) => {
                mediaList.push({ id: doc.id, ...doc.data() });
            });
            mediaList.sort((a, b) => b.timestamp - a.timestamp);
            mediaGallery = mediaList;
            renderUI();
        }, (error) => {
            console.error("Firestore medya okuma hatasÄ±:", error);
            connectionStatus = 'Medya baÄŸlantÄ± hatasÄ±.';
            showModal(`Medya akÄ±ÅŸÄ±nÄ± alÄ±rken hata oluÅŸtu: ${error.message}`, 'error');
            renderUI();
        });

        // Sohbet MesajlarÄ±nÄ± Dinle
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        const unsubscribeChat = onSnapshot(chatCollectionRef, (querySnapshot) => {
            const chatList = [];
            querySnapshot.forEach((doc) => {
                chatList.push({ id: doc.id, ...doc.data() });
            });
            chatList.sort((a, b) => a.timestamp - b.timestamp);
            chatMessages = chatList;
            renderUI();
            const chatEndRef = document.getElementById('chat-end');
            if (chatEndRef) {
                chatEndRef.scrollIntoView({ behavior: 'smooth' });
            }
        }, (error) => {
            console.error("Firestore sohbet okuma hatasÄ±:", error);
            showModal(`Sohbet mesajlarÄ±nÄ± alÄ±rken hata oluÅŸtu: ${error.message}`, 'error');
        });

        return { unsubscribeMedia, unsubscribeChat };
    };

    let unsubscribeFunctions = { unsubscribeMedia: null, unsubscribeChat: null };

    // Yeni bir baÄŸlantÄ± kodu oluÅŸturur
    const createConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yÃ¼kleniyor, lÃ¼tfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        renderUI();
        const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, newCode);
        
        try {
            await Promise.race([
                setDoc(connectionDocRef, {
                    creatorId: userId,
                    status: 'waiting',
                    timestamp: Date.now(),
                }),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Connection creation timed out.')), 10000))
            ]);
            
            connectionCode = newCode;
            isVerici = true;
            connectionStatus = `GÃ¶nderici kodu: ${newCode}. AlÄ±cÄ± bekleniyor...`;
            unsubscribeFunctions = setupFirestoreListeners();
        } catch (e) {
            console.error("Firestore baÄŸlantÄ± oluÅŸturma hatasÄ±:", e);
            showModal(`BaÄŸlantÄ± oluÅŸturulamadÄ±: ${e.message || 'Bilinmeyen bir hata oluÅŸtu.'}`, 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };

    // Bir baÄŸlantÄ±ya katÄ±lÄ±r
    const joinConnection = async () => {
        if (!isFirebaseReady || !userId) {
            showModal("Firebase yÃ¼kleniyor, lÃ¼tfen bekleyin.", 'error');
            return;
        }
        isConnecting = true;
        connectionStatus = 'BaÄŸlanÄ±yor...';
        renderUI();

        const connectionDocRef = doc(db, `/artifacts/${appId}/public/data/connections`, mediaCode);
        try {
            const docSnap = await Promise.race([
                getDoc(connectionDocRef),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Connection lookup timed out.')), 10000))
            ]);

            if (docSnap.exists()) {
                connectionCode = mediaCode;
                isVerici = false;
                connectionStatus = 'BaÄŸlantÄ± baÅŸarÄ±lÄ±! Kameraya geÃ§iliyor...';
                await startCamera();
                unsubscribeFunctions = setupFirestoreListeners();
            } else {
                connectionStatus = 'YanlÄ±ÅŸ kod veya baÄŸlantÄ± bulunamadÄ±.';
                showModal('BaÄŸlantÄ± bulunamadÄ±. LÃ¼tfen kodu kontrol edin.', 'error');
            }
        } catch (e) {
            console.error("Firestore baÄŸlantÄ± hatasÄ±:", e);
            connectionStatus = 'BaÄŸlantÄ± hatasÄ±.';
            showModal(`BaÄŸlantÄ± hatasÄ±: ${e.message || 'Bilinmeyen bir hata oluÅŸtu.'}`, 'error');
        } finally {
            isConnecting = false;
            renderUI();
        }
    };

    // Kamera eriÅŸimini baÅŸlatÄ±r
    const startCamera = async () => {
        try {
            const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            stream = mediaStream;
            videoRef.srcObject = mediaStream;
            videoRef.play();
            connectionStatus = 'Kamera hazÄ±r. FotoÄŸraf veya video Ã§ekebilirsiniz.';
        } catch (err) {
            console.error("Kamera eriÅŸimi baÅŸarÄ±sÄ±z oldu:", err);
            connectionStatus = "Kamera eriÅŸimi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen izinleri kontrol edin.";
            showModal("Kamera eriÅŸimi reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan izinleri verin.", 'error');
        }
    };

    // FotoÄŸraf Ã§eker ve Firestore'a gÃ¶nderir
    const takePhoto = async () => {
        if (!videoRef || !canvasRef || !connectionCode) return;
        isSending = true;
        renderUI();

        const context = canvasRef.getContext('2d');
        canvasRef.width = videoRef.videoWidth;
        canvasRef.height = videoRef.videoHeight;
        context.drawImage(videoRef, 0, 0, videoRef.videoWidth, videoRef.videoHeight);
        const photoDataUrl = canvasRef.toDataURL('image/png');
        
        const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
        try {
            await addDoc(mediaCollectionRef, {
                type: 'photo',
                data: photoDataUrl,
                timestamp: Date.now(),
            });
            showModal("FotoÄŸraf baÅŸarÄ±yla gÃ¶nderildi!", 'success');
        } catch (e) {
            console.error("Firestore fotoÄŸraf gÃ¶nderme hatasÄ±:", e);
            showModal("FotoÄŸraf gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
        } finally {
            isSending = false;
            renderUI();
        }
    };

    // Video kaydÄ±nÄ± baÅŸlatÄ±r
    const startRecording = () => {
        if (!stream || !connectionCode) return;
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                chunks.push(e.data);
            }
        };

        mediaRecorder.onstop = async () => {
            isSending = true;
            renderUI();
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const videoDataUrl = reader.result;
                const mediaCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/media`);
                try {
                    await addDoc(mediaCollectionRef, {
                        type: 'video',
                        data: videoDataUrl,
                        timestamp: Date.now(),
                    });
                    showModal("Video baÅŸarÄ±yla gÃ¶nderildi!", 'success');
                } catch (e) {
                    console.error("Firestore video gÃ¶nderme hatasÄ±:", e);
                    showModal("Video gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
                } finally {
                    isSending = false;
                    renderUI();
                }
            };
        };

        mediaRecorder.start();
        isRecording = true;
        renderUI();
    };

    // Video kaydÄ±nÄ± durdurur
    const stopRecording = () => {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            renderUI();
        }
    };

    // Sohbet mesajÄ± gÃ¶nderir
    const sendChatMessage = async () => {
        const chatInput = document.getElementById('chat-input');
        if (chatInput && chatInput.value.trim() === '' || !connectionCode) return;
        
        const chatCollectionRef = collection(db, `/artifacts/${appId}/public/data/connections/${connectionCode}/chat`);
        try {
            await addDoc(chatCollectionRef, {
                message: chatInput.value,
                senderId: userId,
                timestamp: Date.now(),
            });
            chatInput.value = '';
        } catch (e) {
            console.error("Sohbet mesajÄ± gÃ¶nderme hatasÄ±:", e);
            showModal("Mesaj gÃ¶nderilirken bir hata oluÅŸtu.", 'error');
        }
    };

    // UygulamayÄ± sÄ±fÄ±rlar
    const resetApp = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (unsubscribeFunctions.unsubscribeMedia) unsubscribeFunctions.unsubscribeMedia();
        if (unsubscribeFunctions.unsubscribeChat) unsubscribeFunctions.unsubscribeChat();

        stream = null;
        mediaGallery = [];
        chatMessages = [];
        isVerici = false;
        isRecording = false;
        isSending = false;
        mediaCode = '';
        connectionCode = null;
        connectionStatus = 'BaÄŸlantÄ± bekleniyor...';
        
        renderUI();
    };

    // ArayÃ¼zÃ¼ oluÅŸturur ve gÃ¼nceller
    const renderUI = () => {
        appRoot.innerHTML = '';
        
        // Modal
        if (modalMessage) {
            const modalHTML = `
                <div class="modal">
                  <div class="modal-content">
                    <h3>${modalType === 'success' ? 'BaÅŸarÄ±lÄ±' : 'Hata'}</h3>
                    <p>${modalMessage}</p>
                    <button id="modal-close-btn" class="btn ${modalType === 'success' ? 'btn-green' : 'btn-red'}">Tamam</button>
                  </div>
                </div>
            `;
            appRoot.insertAdjacentHTML('afterbegin', modalHTML);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        }

        let mainContentHTML = ``;

        if (!isFirebaseReady) {
          mainContentHTML = `
            <div style="text-align: center;">
              <p>YÃ¼kleniyor...</p>
            </div>
          `;
        } else {
          mainContentHTML += `
            <header class="header">
                <h1>Kamera UygulamasÄ± ðŸ“¸</h1>
                <button id="reset-btn" class="btn btn-reset">SÄ±fÄ±rla</button>
            </header>

            <div class="status-bar">
                <span>${isConnecting || isSending ? 'Ä°ÅŸleniyor...' : connectionStatus}</span>
            </div>
          `;
          
          if (!connectionCode) {
              mainContentHTML += `
                  <div class="connection-options">
                      <div class="connection-card">
                          <h2>GÃ¶nderici (Ekran)</h2>
                          <p>BaÅŸka bir cihazdan fotoÄŸraf/video almak iÃ§in bir baÄŸlantÄ± kodu oluÅŸturun.</p>
                          <button id="create-connection-btn" class="btn btn-green" ${isConnecting ? 'disabled' : ''}>
                              BaÄŸlantÄ± OluÅŸtur
                          </button>
                      </div>
                      <div class="connection-card">
                          <h2>AlÄ±cÄ± (Kamera)</h2>
                          <p>GÃ¶nderici cihazdan gelen kodu girerek baÄŸlanÄ±n.</p>
                          <div class="input-group">
                              <input id="media-code-input" type="text" value="${mediaCode}" placeholder="Kodu girin..." maxlength="6">
                              <button id="join-connection-btn" class="btn btn-blue" ${isConnecting || mediaCode.length !== 6 ? 'disabled' : ''}>
                                  BaÄŸlan
                              </button>
                          </div>
                      </div>
                  </div>
              `;
          } else {
              let mediaSection = '';
              if (!isVerici && stream) {
                  mediaSection = `<video id="camera-video-display" style="width:100%; height:auto;" autoplay playsinline></video>`;
              } else if (isVerici && mediaGallery.length === 0) {
                  mediaSection = `<p style="color:#bbb; text-align:center;">AlÄ±cÄ± cihazdan medya bekleniyor...</p>`;
              } else if (isVerici && mediaGallery.length > 0) {
                  mediaSection = `<div class="media-gallery">
                      ${mediaGallery.map(media => `
                          <div class="media-item">
                              ${media.type === 'photo' ? `<img src="${media.data}" alt="AlÄ±nan FotoÄŸraf" style="width:100%; height:auto;" />` : `<video src="${media.data}" controls style="width:100%; height:auto;"></video>`}
                          </div>
                      `).join('')}
                  </div>`;
              }

              let controlSection = '';
              if (!isVerici) {
                  controlSection = `
                      <div style="display:flex; flex-direction:column; gap:10px;">
                          <div style="display:flex; gap:10px;">
                              <button id="take-photo-btn" class="btn btn-purple" style="flex-grow:1;" ${isSending ? 'disabled' : ''}>
                                  ${isSending ? 'GÃ¶nderiliyor...' : 'FotoÄŸraf Ã‡ek'}
                              </button>
                              <button id="record-video-btn" class="btn ${isRecording ? 'btn-red' : 'btn-green'}" style="flex-grow:1;" ${isSending ? 'disabled' : ''}>
                                  ${isRecording ? 'KaydÄ± Durdur' : 'Video Kaydet'}
                              </button>
                          </div>
                          <p style="text-align:center; color:#bbb;">
                              Kamera modundasÄ±nÄ±z. Ã‡ektiÄŸiniz medya diÄŸer cihaza gÃ¶nderilecektir.
                          </p>
                      </div>
                  `;
              } else {
                  controlSection = `
                      <div class="chat-section">
                          <h3>Sohbet</h3>
                          <div id="chat-messages-container" class="chat-messages">
                              ${chatMessages.map(msg => `
                                  <div class="chat-message ${msg.senderId === userId ? 'sent' : 'received'}">
                                      <p>${msg.message}</p>
                                      <span style="font-size:10px; color:#bbb;">
                                          ${new Date(msg.timestamp).toLocaleTimeString()}
                                      </span>
                                  </div>
                              `).join('')}
                              <div id="chat-end"></div>
                          </div>
                          <div class="chat-input-group">
                              <input id="chat-input" type="text" placeholder="Bir mesaj yazÄ±n...">
                              <button id="send-chat-btn" class="btn btn-blue">GÃ¶nder</button>
                          </div>
                      </div>
                  `;
              }

              mainContentHTML += `
                  <div class="media-and-controls">
                      <div class="media-display">
                          ${mediaSection}
                      </div>
                      ${controlSection}
                  </div>
              `;
          }
        }

        appRoot.innerHTML = mainContentHTML;
        
        // Olay dinleyicilerini ekle
        document.getElementById('reset-btn')?.addEventListener('click', resetApp);
        
        if (!connectionCode) {
            document.getElementById('create-connection-btn')?.addEventListener('click', createConnection);
            const mediaCodeInput = document.getElementById('media-code-input');
            const joinButton = document.getElementById('join-connection-btn');
            
            mediaCodeInput?.addEventListener('input', (e) => {
                mediaCode = e.target.value.toUpperCase();
                joinButton.disabled = isConnecting || mediaCode.length !== 6;
            });
            joinButton?.addEventListener('click', joinConnection);
        } else {
            if (!isVerici) {
                document.getElementById('take-photo-btn')?.addEventListener('click', takePhoto);
                const recordVideoBtn = document.getElementById('record-video-btn');
                recordVideoBtn?.addEventListener('click', () => {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            } else {
                document.getElementById('send-chat-btn')?.addEventListener('click', sendChatMessage);
                document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        }

        // video ve canvas elementlerini body'ye ekle
        if (!document.body.contains(videoRef)) {
          videoRef.style.display = 'none';
          document.body.appendChild(videoRef);
        }
        if (!document.body.contains(canvasRef)) {
          canvasRef.style.display = 'none';
          document.body.appendChild(canvasRef);
        }

        if (!isVerici && connectionCode) {
            const videoDisplay = document.getElementById('camera-video-display');
            if (videoDisplay) {
                videoRef.srcObject = stream;
                videoDisplay.srcObject = stream;
            }
        }
    };
    
    // Firebase baÅŸlangÄ±Ã§ fonksiyonu
    const initFirebase = async () => {
      try {
        console.log("Firebase baÅŸlatÄ±lÄ±yor...");
        
        if (Object.keys(firebaseConfig).length === 0) {
            throw new Error("Firebase yapÄ±landÄ±rma bilgileri eksik. LÃ¼tfen 'firebaseConfig' objesinin doÄŸru yÃ¼klendiÄŸinden emin olun.");
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        console.log("onAuthStateChanged dinleyicisi ayarlanÄ±yor...");
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isFirebaseReady = true;
                console.log(`Firebase hazÄ±r. KullanÄ±cÄ± kimliÄŸi: ${userId}`);
                renderUI();
            } else {
                console.log("KullanÄ±cÄ± oturumu aÃ§Ä±lmamÄ±ÅŸ. Anonim olarak oturum aÃ§mayÄ± deniyorum...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Firebase Kimlik DoÄŸrulama hatasÄ±:", e);
                    let errorMessage = `Firebase'a baÄŸlanÄ±rken bir hata oluÅŸtu: ${e.message}`;
                    if (e.code === 'auth/configuration-not-found') {
                        errorMessage = 'Hata: Firebase projenizde "Anonymous" (Anonim) oturum aÃ§ma yÃ¶ntemi etkinleÅŸtirilmemiÅŸ.';
                    } else if (e.code === 'auth/network-request-failed') {
                        errorMessage = 'Hata: Ä°nternet baÄŸlantÄ±nÄ±zda sorun olabilir. LÃ¼tfen kontrol edin.';
                    }
                    showModal(errorMessage, 'error');
                    isFirebaseReady = false;
                    renderUI();
                }
            }
        });

      } catch (e) {
        console.error("Firebase baÅŸlatma hatasÄ±:", e);
        showModal(`Uygulama baÅŸlatÄ±lÄ±rken bir hata oluÅŸtu: ${e.message}`, 'error');
        isFirebaseReady = false;
        renderUI();
      }
    };

    // UygulamayÄ± baÅŸlat
    initFirebase();
  </script>
</body>
</html>
